## ğŸ“– ç›®éŒ„
- [ğŸ“– ç›®éŒ„](#-ç›®éŒ„)
- [ğŸ’³ é‡‘æµçµ±è¨ˆé€²éšåˆ†æ](#-é‡‘æµçµ±è¨ˆé€²éšåˆ†æ)
  - [ğŸ’ æ¯ç¨®é‡‘æµæ¯å¹´æœˆçš„å¹³å‡æ¶ˆè²»ï¼ˆéœ€å¤§æ–¼1000ï¼‰](#-æ¯ç¨®é‡‘æµæ¯å¹´æœˆçš„å¹³å‡æ¶ˆè²»éœ€å¤§æ–¼1000)
    - [ğŸ“… æŒ‰æ—¥æœŸåˆ†çµ„](#-æŒ‰æ—¥æœŸåˆ†çµ„)
    - [ğŸ“ˆ æŒ‰å¹´æœˆåˆ†çµ„](#-æŒ‰å¹´æœˆåˆ†çµ„)
    - [ğŸ—“ï¸ æŒ‰å¹´-æœˆå­—ä¸²åˆ†çµ„](#ï¸-æŒ‰å¹´-æœˆå­—ä¸²åˆ†çµ„)
- [ğŸ“ˆ è¤‡é›œçµ±è¨ˆåˆ†æ](#-è¤‡é›œçµ±è¨ˆåˆ†æ)
  - [ğŸ’ æ¯å°æ™‚ä»˜æ¬¾æˆåŠŸç‡](#-æ¯å°æ™‚ä»˜æ¬¾æˆåŠŸç‡)
    - [ğŸ¯ åŸºæœ¬ç‰ˆæœ¬](#-åŸºæœ¬ç‰ˆæœ¬)
    - [ğŸš€ é€²éšç‰ˆæœ¬ï¼šè‡ªè¨‚æ™‚é–“æ ¡æ­£](#-é€²éšç‰ˆæœ¬è‡ªè¨‚æ™‚é–“æ ¡æ­£)
- [ğŸ¯ æ•ˆèƒ½å„ªåŒ–é€²éšæŠ€å·§](#-æ•ˆèƒ½å„ªåŒ–é€²éšæŠ€å·§)
  - [âš¡ ç´¢å¼•ç­–ç•¥èˆ‡ SARGable æŸ¥è©¢](#-ç´¢å¼•ç­–ç•¥èˆ‡-sargable-æŸ¥è©¢)
    - [ä»€éº¼æ˜¯ SARGableï¼Ÿ](#ä»€éº¼æ˜¯-sargable)
    - [ğŸ“ˆ æ•ˆèƒ½å„ªåŒ–å¯¦ä¾‹](#-æ•ˆèƒ½å„ªåŒ–å¯¦ä¾‹)
  - [ğŸ” æš«å­˜è¡¨èˆ‡æ‰¹æ¬¡è™•ç†](#-æš«å­˜è¡¨èˆ‡æ‰¹æ¬¡è™•ç†)
    - [æš«å­˜è¡¨çš„æœ‰æ•ˆé‹ç”¨](#æš«å­˜è¡¨çš„æœ‰æ•ˆé‹ç”¨)
  - [ğŸ“Š CTE èˆ‡å­æŸ¥è©¢å„ªåŒ–](#-cte-èˆ‡å­æŸ¥è©¢å„ªåŒ–)
    - [Common Table Expression (CTE) çš„æœ€ä½³å¯¦è¸](#common-table-expression-cte-çš„æœ€ä½³å¯¦è¸)
- [ğŸ› ï¸ å¯¦æˆ°æ•ˆèƒ½èª¿æ ¡æ¡ˆä¾‹](#ï¸-å¯¦æˆ°æ•ˆèƒ½èª¿æ ¡æ¡ˆä¾‹)
  - [ğŸ“‹ æ¡ˆä¾‹ä¸€ï¼šå¤§é‡è³‡æ–™çš„æ™‚é–“ç¯„åœæŸ¥è©¢å„ªåŒ–](#-æ¡ˆä¾‹ä¸€å¤§é‡è³‡æ–™çš„æ™‚é–“ç¯„åœæŸ¥è©¢å„ªåŒ–)
    - [å•é¡Œå ´æ™¯](#å•é¡Œå ´æ™¯)
    - [å„ªåŒ–æ–¹æ¡ˆ](#å„ªåŒ–æ–¹æ¡ˆ)
  - [ğŸ“‹ æ¡ˆä¾‹äºŒï¼šè¤‡é›œçµ±è¨ˆæŸ¥è©¢çš„åˆ†è§£å„ªåŒ–](#-æ¡ˆä¾‹äºŒè¤‡é›œçµ±è¨ˆæŸ¥è©¢çš„åˆ†è§£å„ªåŒ–)
    - [å•é¡Œå ´æ™¯](#å•é¡Œå ´æ™¯-1)
    - [å„ªåŒ–æ–¹æ¡ˆ](#å„ªåŒ–æ–¹æ¡ˆ-1)
- [ğŸ† æ•ˆèƒ½å„ªåŒ–ç¸½çµ](#-æ•ˆèƒ½å„ªåŒ–ç¸½çµ)
  - [ğŸ¯ é—œéµåŸå‰‡](#-é—œéµåŸå‰‡)
  - [ğŸ“Š æ•ˆèƒ½æª¢æŸ¥æ¸…å–®](#-æ•ˆèƒ½æª¢æŸ¥æ¸…å–®)
- [ğŸ”— ç›¸é—œæ–‡ä»¶](#-ç›¸é—œæ–‡ä»¶)

---

## ğŸ’³ é‡‘æµçµ±è¨ˆé€²éšåˆ†æ

### ğŸ’ æ¯ç¨®é‡‘æµæ¯å¹´æœˆçš„å¹³å‡æ¶ˆè²»ï¼ˆéœ€å¤§æ–¼1000ï¼‰

é€™å€‹æ¡ˆä¾‹å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ä¸åŒçš„åˆ†çµ„ç­–ç•¥ä¾†åˆ†æé‡‘æµè³‡æ–™ï¼Œæ¯ç¨®æ–¹æ³•éƒ½æœ‰å…¶é©ç”¨å ´æ™¯ï¼š

#### ğŸ“… æŒ‰æ—¥æœŸåˆ†çµ„
```sql
USE WebStoreDB;

-- ğŸ¯ åˆ†é è¨­å®šï¼ˆç¬¬ä¸€é é¡¯ç¤ºä»Šå¹´ï¼‰
DECLARE @pageNum INT = 1;
DECLARE @targetYear INT = YEAR(GETDATE()) - (@pageNum - 1);
DECLARE @startDate DATETIME = DATEFROMPARTS(@targetYear, 1, 1);
DECLARE @endDate DATETIME = DATEFROMPARTS(@targetYear + 1, 1, 1);

SELECT 
    TradesOrderThirdPartyPayment_TypeDef AS é‡‘æµé¡å‹,
    CAST(TradesOrderThirdPartyPayment_DateTime AS DATE) AS ä»˜æ¬¾æ—¥æœŸ,
    AVG(TradesOrderThirdPartyPayment_TotalPayment) AS å¹³å‡æ¶ˆè²»
FROM TradesOrderThirdPartyPayment(NOLOCK)
WHERE TradesOrderThirdPartyPayment_ValidFlag = 1
    AND TradesOrderThirdPartyPayment_DateTime >= @startDate
    AND TradesOrderThirdPartyPayment_DateTime < @endDate
GROUP BY 
    TradesOrderThirdPartyPayment_TypeDef, 
    CAST(TradesOrderThirdPartyPayment_DateTime AS DATE)
HAVING AVG(TradesOrderThirdPartyPayment_TotalPayment) > 1000
ORDER BY ä»˜æ¬¾æ—¥æœŸ;
```

> ğŸ“Š **é©ç”¨å ´æ™¯**ï¼šéœ€è¦æŸ¥çœ‹æ¯æ—¥è©³ç´°æ•¸æ“šçš„è¶¨å‹¢åˆ†æ

#### ğŸ“ˆ æŒ‰å¹´æœˆåˆ†çµ„
```sql
SELECT 
    TradesOrderThirdPartyPayment_TypeDef AS é‡‘æµé¡å‹,
    YEAR(TradesOrderThirdPartyPayment_DateTime) AS å¹´ä»½,
    MONTH(TradesOrderThirdPartyPayment_DateTime) AS æœˆä»½,
    AVG(TradesOrderThirdPartyPayment_TotalPayment) AS å¹³å‡æ¶ˆè²»
FROM TradesOrderThirdPartyPayment(NOLOCK)
WHERE TradesOrderThirdPartyPayment_ValidFlag = 1
    AND TradesOrderThirdPartyPayment_DateTime >= @startDate
    AND TradesOrderThirdPartyPayment_DateTime < @endDate
GROUP BY 
    TradesOrderThirdPartyPayment_TypeDef,
    YEAR(TradesOrderThirdPartyPayment_DateTime),
    MONTH(TradesOrderThirdPartyPayment_DateTime)
HAVING AVG(TradesOrderThirdPartyPayment_TotalPayment) > 1000
ORDER BY å¹´ä»½, æœˆä»½;
```

> ğŸ“Š **é©ç”¨å ´æ™¯**ï¼šéœ€è¦åœ¨å ±è¡¨ä¸­åˆ†åˆ¥é¡¯ç¤ºå¹´ä»½å’Œæœˆä»½æ¬„ä½

#### ğŸ—“ï¸ æŒ‰å¹´-æœˆå­—ä¸²åˆ†çµ„
```sql
SELECT 
    TradesOrderThirdPartyPayment_TypeDef AS é‡‘æµé¡å‹,
    CONVERT(CHAR(7), TradesOrderThirdPartyPayment_DateTime, 120) AS å¹´æœˆ,
    AVG(TradesOrderThirdPartyPayment_TotalPayment) AS å¹³å‡æ¶ˆè²»
FROM TradesOrderThirdPartyPayment(NOLOCK)
WHERE TradesOrderThirdPartyPayment_ValidFlag = 1
    AND TradesOrderThirdPartyPayment_DateTime >= @startDate
    AND TradesOrderThirdPartyPayment_DateTime < @endDate
GROUP BY 
    TradesOrderThirdPartyPayment_TypeDef, 
    CONVERT(CHAR(7), TradesOrderThirdPartyPayment_DateTime, 120)
HAVING AVG(TradesOrderThirdPartyPayment_TotalPayment) > 1000
ORDER BY å¹´æœˆ;
```

> ğŸ“Š **é©ç”¨å ´æ™¯**ï¼šéœ€è¦ç·Šæ¹Šæ ¼å¼é¡¯ç¤ºï¼Œé©åˆåœ–è¡¨å±•ç¤º

---

## ğŸ“ˆ è¤‡é›œçµ±è¨ˆåˆ†æ

### ğŸ’ æ¯å°æ™‚ä»˜æ¬¾æˆåŠŸç‡

é€™æ˜¯ä¸€å€‹è¤‡é›œçš„å•†æ¥­åˆ†ææ¡ˆä¾‹ï¼Œç”¨æ–¼ç›£æ§æ”¯ä»˜ç³»çµ±çš„ç©©å®šæ€§å’ŒæˆåŠŸç‡ã€‚

#### ğŸ¯ åŸºæœ¬ç‰ˆæœ¬
```sql
USE WebStoreDB;

SELECT 
    DATEADD(HOUR, DATEDIFF(HOUR, 0, TradesOrderThirdPartyPayment_DateTime), 0) AS å°æ™‚å€é–“,
    COUNT(*) AS ç¸½ç­†æ•¸,
    SUM(CASE WHEN TradesOrderThirdPartyPayment_StatusDef = 'Success' THEN 1 ELSE 0 END) AS æˆåŠŸç­†æ•¸,
    CAST(1.0 * SUM(CASE WHEN TradesOrderThirdPartyPayment_StatusDef = 'Success' THEN 1 ELSE 0 END) / COUNT(*) 
         AS DECIMAL(10,2)) AS æˆåŠŸç‡
FROM TradesOrderThirdPartyPayment(NOLOCK)
WHERE TradesOrderThirdPartyPayment_ValidFlag = 1
    AND TradesOrderThirdPartyPayment_TypeDef = 'CreditCardOnce_Stripe'
    AND TradesOrderThirdPartyPayment_DateTime > '2025-01-01 09:00'
GROUP BY DATEADD(HOUR, DATEDIFF(HOUR, 0, TradesOrderThirdPartyPayment_DateTime), 0)
ORDER BY å°æ™‚å€é–“;
```

> ğŸ” **æŠ€è¡“è§£æ**ï¼š
> - `DATEADD(HOUR, DATEDIFF(HOUR, 0, datetime), 0)` æ˜¯å°‡æ™‚é–“æˆªæ–·åˆ°å°æ™‚çš„ç¶“å…¸æŠ€å·§
> - ä½¿ç”¨ `1.0 *` ç¢ºä¿é™¤æ³•çµæœç‚ºå°æ•¸è€Œéæ•´æ•¸

#### ğŸš€ é€²éšç‰ˆæœ¬ï¼šè‡ªè¨‚æ™‚é–“æ ¡æ­£
```sql
-- ğŸ›ï¸ å¯èª¿æ•´çš„é‡‘æµé¡å‹
-- EWallet_PayMe, CreditCardOnce_Stripe
DECLARE @payType VARCHAR(30) = 'CreditCardOnce_Stripe';

WITH PaymentStats AS (
    SELECT 
        -- â° è‡ªè¨‚æ™‚é–“æ ¡æ­£ï¼šæ¸›å»23åˆ†35ç§’
        DATEADD(HOUR, DATEDIFF(HOUR, 0, 
                DATEADD(SECOND, -35, DATEADD(MINUTE, -23, TradesOrderThirdPartyPayment_CreatedDateTime))
               ), 0) AS CustomHourly,
        SUM(CASE WHEN TradesOrderThirdPartyPayment_StatusDef NOT IN ('WaitingToPay','Hidden') 
                 THEN 1 ELSE 0 END) AS Total_Count,
        SUM(CASE WHEN TradesOrderThirdPartyPayment_StatusDef IN ('Success','RePaySuccess','AuthSuccess','CancelAfterSuccess') 
                 THEN 1 ELSE 0 END) AS Success_Count,
        SUM(CASE WHEN TradesOrderThirdPartyPayment_StatusDef = 'Fail' 
                 THEN 1 ELSE 0 END) AS Fail_Count,
        SUM(CASE WHEN TradesOrderThirdPartyPayment_StatusDef = 'Timeout' 
                 THEN 1 ELSE 0 END) AS Timeout_Count,
        SUM(CASE WHEN TradesOrderThirdPartyPayment_StatusDef = 'CancelRequest' 
                 THEN 1 ELSE 0 END) AS CancelRequest_Count
    FROM TradesOrderThirdPartyPayment (NOLOCK)
    WHERE TradesOrderThirdPartyPayment_TypeDef = @payType
        AND TradesOrderThirdPartyPayment_ValidFlag = 1
        AND TradesOrderThirdPartyPayment_CreatedDateTime >= '2025-03-25'
        AND TradesOrderThirdPartyPayment_CreatedDateTime < '2025-06-25'
    GROUP BY DATEADD(HOUR, DATEDIFF(HOUR, 0, 
                    DATEADD(SECOND, -35, DATEADD(MINUTE, -23, TradesOrderThirdPartyPayment_CreatedDateTime))
                   ), 0)
)
SELECT *,
       CAST(CAST(Success_Count * 100.0 / Total_Count AS DECIMAL(10,2)) AS VARCHAR(30)) + '%' AS æˆåŠŸç‡,
       CAST(CAST(Fail_Count * 100.0 / Total_Count AS DECIMAL(10,2)) AS VARCHAR(30)) + '%' AS å¤±æ•—ç‡,
       DATEADD(SECOND, 35, DATEADD(MINUTE, 23, CustomHourly)) AS é–‹å§‹æ™‚é–“,
       DATEADD(SECOND, 35, DATEADD(MINUTE, 23 + 60, CustomHourly)) AS çµæŸæ™‚é–“
FROM PaymentStats
WHERE Total_Count > 10 
    -- ğŸ“Š å¯é¸çš„æˆåŠŸç‡ç¯©é¸æ¢ä»¶
    -- AND (Success_Count * 1.0 / NULLIF(Total_Count,0)) < 0.6
    -- AND (Success_Count * 1.0 / NULLIF(Total_Count,0)) > 0.5
ORDER BY CustomHourly;
```

> ğŸ¯ **é€²éšç‰¹æ€§**ï¼š
> 1. **æ™‚é–“æ ¡æ­£**ï¼šè€ƒæ…®åˆ°ç³»çµ±æ™‚å€æˆ–å»¶é²ï¼Œå¯ä»¥å°æ™‚é–“é€²è¡Œå¾®èª¿
> 2. **å¤šç‹€æ…‹çµ±è¨ˆ**ï¼šè©³ç´°åˆ†æå„ç¨®ä»˜æ¬¾ç‹€æ…‹çš„åˆ†å¸ƒ
> 3. **å½ˆæ€§ç¯©é¸**ï¼šå¯æ ¹æ“šäº¤æ˜“é‡æˆ–æˆåŠŸç‡é€²è¡Œéæ¿¾
> 4. **å¯è®€æ€§å„ªåŒ–**ï¼šå°‡ç™¾åˆ†æ¯”æ ¼å¼åŒ–ç‚ºæ˜“è®€çš„å­—ä¸²æ ¼å¼

---

## ğŸ¯ æ•ˆèƒ½å„ªåŒ–é€²éšæŠ€å·§

### âš¡ ç´¢å¼•ç­–ç•¥èˆ‡ SARGable æŸ¥è©¢

#### ä»€éº¼æ˜¯ SARGableï¼Ÿ
**SARGable** = **S**earch **ARG**ument **able**ï¼Œæ„æ€æ˜¯æŸ¥è©¢æ¢ä»¶èƒ½å¤ æœ‰æ•ˆåˆ©ç”¨ç´¢å¼•ã€‚

```sql
-- âœ… SARGable æŸ¥è©¢ - å¯ä»¥æœ‰æ•ˆåˆ©ç”¨ç´¢å¼•
WHERE CreatedDateTime >= '2025-01-01' 
    AND CreatedDateTime < '2025-02-01'
WHERE UserId = 12345
WHERE Status IN ('Active', 'Pending')

-- âŒ Non-SARGable æŸ¥è©¢ - ç„¡æ³•æœ‰æ•ˆåˆ©ç”¨ç´¢å¼•
WHERE YEAR(CreatedDateTime) = 2025          -- åœ¨æ¬„ä½ä¸Šä½¿ç”¨å‡½å¼
WHERE MONTH(CreatedDateTime) = 1            -- åœ¨æ¬„ä½ä¸Šä½¿ç”¨å‡½å¼
WHERE UserName LIKE '%John%'               -- å‰ç½®è¬ç”¨å­—å…ƒ
WHERE UserId + 10 = 12355                  -- åœ¨æ¬„ä½ä¸Šé€²è¡Œé‹ç®—
```

#### ğŸ“ˆ æ•ˆèƒ½å„ªåŒ–å¯¦ä¾‹
```sql
-- âŒ æ•ˆèƒ½è¼ƒå·®ï¼šNon-SARGable
SELECT * FROM Orders 
WHERE YEAR(OrderDate) = 2025 AND MONTH(OrderDate) = 7;

-- âœ… æ•ˆèƒ½è¼ƒä½³ï¼šSARGable  
DECLARE @startDate DATE = '2025-07-01';
DECLARE @endDate DATE = '2025-08-01';

SELECT * FROM Orders 
WHERE OrderDate >= @startDate AND OrderDate < @endDate;
```

### ğŸ” æš«å­˜è¡¨èˆ‡æ‰¹æ¬¡è™•ç†

#### æš«å­˜è¡¨çš„æœ‰æ•ˆé‹ç”¨
```sql
-- ğŸ’¡ è™•ç†å¤§é‡è³‡æ–™æ™‚çš„æœ€ä½³å¯¦è¸
DROP TABLE IF EXISTS #MonthlyStats;
CREATE TABLE #MonthlyStats (
    YearMonth CHAR(7),
    TotalAmount DECIMAL(18,2),
    OrderCount INT,
    AvgAmount DECIMAL(18,2),
    INDEX IX_YearMonth (YearMonth)  -- å»ºç«‹ç´¢å¼•æå‡æŸ¥è©¢æ•ˆèƒ½
);

-- åˆ†æ‰¹è™•ç†é¿å…é•·æ™‚é–“é–å®š
DECLARE @batchSize INT = 10000;
DECLARE @offset INT = 0;
DECLARE @rowCount INT = 1;

WHILE @rowCount > 0
BEGIN
    INSERT INTO #MonthlyStats (YearMonth, TotalAmount, OrderCount, AvgAmount)
    SELECT 
        CONVERT(CHAR(7), OrderDate, 120),
        SUM(Amount),
        COUNT(*),
        AVG(Amount)
    FROM Orders
    WHERE OrderId BETWEEN @offset + 1 AND @offset + @batchSize
    GROUP BY CONVERT(CHAR(7), OrderDate, 120);
    
    SET @rowCount = @@ROWCOUNT;
    SET @offset = @offset + @batchSize;
END;
```

### ğŸ“Š CTE èˆ‡å­æŸ¥è©¢å„ªåŒ–

#### Common Table Expression (CTE) çš„æœ€ä½³å¯¦è¸
```sql
-- ğŸ¯ è¤‡é›œåˆ†æä½¿ç”¨ CTE æå‡å¯è®€æ€§
WITH MonthlyRevenue AS (
    -- ç¬¬ä¸€å±¤ï¼šè¨ˆç®—æ¯æœˆæ”¶å…¥
    SELECT 
        YEAR(OrderDate) AS OrderYear,
        MONTH(OrderDate) AS OrderMonth,
        SUM(Amount) AS MonthlyTotal,
        COUNT(*) AS OrderCount
    FROM Orders 
    WHERE OrderDate >= '2024-01-01'
    GROUP BY YEAR(OrderDate), MONTH(OrderDate)
),
RevenueWithGrowth AS (
    -- ç¬¬äºŒå±¤ï¼šè¨ˆç®—æˆé•·ç‡
    SELECT *,
        LAG(MonthlyTotal) OVER (ORDER BY OrderYear, OrderMonth) AS PrevMonthTotal,
        MonthlyTotal - LAG(MonthlyTotal) OVER (ORDER BY OrderYear, OrderMonth) AS GrowthAmount
    FROM MonthlyRevenue
)
-- ç¬¬ä¸‰å±¤ï¼šæœ€çµ‚çµæœ
SELECT *,
    CASE 
        WHEN PrevMonthTotal IS NULL THEN NULL
        WHEN PrevMonthTotal = 0 THEN NULL
        ELSE CAST(GrowthAmount * 100.0 / PrevMonthTotal AS DECIMAL(5,2))
    END AS GrowthPercentage
FROM RevenueWithGrowth
ORDER BY OrderYear, OrderMonth;
```

---

## ğŸ› ï¸ å¯¦æˆ°æ•ˆèƒ½èª¿æ ¡æ¡ˆä¾‹

### ğŸ“‹ æ¡ˆä¾‹ä¸€ï¼šå¤§é‡è³‡æ–™çš„æ™‚é–“ç¯„åœæŸ¥è©¢å„ªåŒ–

#### å•é¡Œå ´æ™¯
```sql
-- âŒ åŸå§‹æŸ¥è©¢ï¼šæ•ˆèƒ½è¼ƒå·®
SELECT COUNT(*) 
FROM LargeTable 
WHERE YEAR(CreateDate) = 2025 AND MONTH(CreateDate) BETWEEN 1 AND 6;
```

#### å„ªåŒ–æ–¹æ¡ˆ
```sql
-- âœ… å„ªåŒ–å¾Œï¼šä½¿ç”¨ç¯„åœæŸ¥è©¢
DECLARE @startDate DATE = '2025-01-01';
DECLARE @endDate DATE = '2025-07-01';

SELECT COUNT(*) 
FROM LargeTable 
WHERE CreateDate >= @startDate AND CreateDate < @endDate;

-- ğŸ“Š å»ºè­°çš„ç´¢å¼•
-- CREATE INDEX IX_LargeTable_CreateDate ON LargeTable(CreateDate) INCLUDE (OtherColumns);
```

### ğŸ“‹ æ¡ˆä¾‹äºŒï¼šè¤‡é›œçµ±è¨ˆæŸ¥è©¢çš„åˆ†è§£å„ªåŒ–

#### å•é¡Œå ´æ™¯
```sql
-- âŒ åŸå§‹æŸ¥è©¢ï¼šè¤‡é›œä¸”é›£ä»¥å„ªåŒ–
SELECT 
    YEAR(OrderDate) AS Year,
    MONTH(OrderDate) AS Month,
    COUNT(*) AS OrderCount,
    SUM(Amount) AS TotalAmount,
    AVG(Amount) AS AvgAmount,
    COUNT(DISTINCT CustomerId) AS UniqueCustomers,
    MAX(Amount) AS MaxAmount,
    MIN(Amount) AS MinAmount
FROM Orders o
WHERE OrderDate >= '2024-01-01' 
    AND EXISTS (SELECT 1 FROM Customers c WHERE c.Id = o.CustomerId AND c.Status = 'Active')
GROUP BY YEAR(OrderDate), MONTH(OrderDate)
ORDER BY Year, Month;
```

#### å„ªåŒ–æ–¹æ¡ˆ
```sql
-- âœ… å„ªåŒ–å¾Œï¼šåˆ†è§£æˆå¤šå€‹æ­¥é©Ÿ
-- æ­¥é©Ÿä¸€ï¼šå…ˆç¯©é¸æœ‰æ•ˆå®¢æˆ¶çš„è¨‚å–®
WITH ValidOrders AS (
    SELECT o.OrderDate, o.Amount, o.CustomerId
    FROM Orders o
    INNER JOIN Customers c ON c.Id = o.CustomerId 
    WHERE o.OrderDate >= '2024-01-01'
        AND c.Status = 'Active'
)
-- æ­¥é©ŸäºŒï¼šé€²è¡Œçµ±è¨ˆåˆ†æ
SELECT 
    YEAR(OrderDate) AS Year,
    MONTH(OrderDate) AS Month,
    COUNT(*) AS OrderCount,
    SUM(Amount) AS TotalAmount,
    AVG(Amount) AS AvgAmount,
    COUNT(DISTINCT CustomerId) AS UniqueCustomers,
    MAX(Amount) AS MaxAmount,
    MIN(Amount) AS MinAmount
FROM ValidOrders
GROUP BY YEAR(OrderDate), MONTH(OrderDate)
ORDER BY Year, Month;
```

---

## ğŸ† æ•ˆèƒ½å„ªåŒ–ç¸½çµ

### ğŸ¯ é—œéµåŸå‰‡
1. **SARGable æŸ¥è©¢**ï¼šé¿å…åœ¨ WHERE æ¢ä»¶ä¸­å°ç´¢å¼•æ¬„ä½ä½¿ç”¨å‡½å¼
2. **ç´¢å¼•ç­–ç•¥**ï¼šåˆé©çš„ç´¢å¼•æ˜¯æ•ˆèƒ½çš„åŸºç¤
3. **æ‰¹æ¬¡è™•ç†**ï¼šå¤§é‡è³‡æ–™è™•ç†æ™‚ä½¿ç”¨æš«å­˜è¡¨å’Œæ‰¹æ¬¡æ“ä½œ
4. **æŸ¥è©¢åˆ†è§£**ï¼šè¤‡é›œæŸ¥è©¢åˆ†è§£æˆå¤šå€‹ç°¡å–®æ­¥é©Ÿ

### ğŸ“Š æ•ˆèƒ½æª¢æŸ¥æ¸…å–®
- [ ] æŸ¥è©¢æ˜¯å¦ä½¿ç”¨äº† SARGable æ¢ä»¶ï¼Ÿ
- [ ] æ˜¯å¦æœ‰é©ç•¶çš„ç´¢å¼•æ”¯æ´æŸ¥è©¢ï¼Ÿ
- [ ] å¤§é‡è³‡æ–™æ˜¯å¦ä½¿ç”¨æ‰¹æ¬¡è™•ç†ï¼Ÿ
- [ ] è¤‡é›œé‚è¼¯æ˜¯å¦é©åˆç”¨ CTE åˆ†è§£ï¼Ÿ
- [ ] æ˜¯å¦é¿å…äº†ä¸å¿…è¦çš„å‡½å¼å‘¼å«ï¼Ÿ

---

## ğŸ”— ç›¸é—œæ–‡ä»¶

- [SQL æ™‚é–“é¡å‹èˆ‡åŸºæœ¬æ“ä½œå®Œæ•´æŒ‡å—](./SQL_æ™‚é–“é¡å‹èˆ‡åŸºæœ¬æ“ä½œå®Œæ•´æŒ‡å—.md)
- [SQL æ™‚é–“æŸ¥è©¢åŸºç¤èˆ‡çµ±è¨ˆæŠ€å·§](./SQL_æ™‚é–“æŸ¥è©¢åŸºç¤èˆ‡çµ±è¨ˆæŠ€å·§.md)

---

*ğŸš€ æŒæ¡é€™äº›é€²éšæŠ€å·§ï¼Œè®“æ‚¨çš„ SQL æŸ¥è©¢ä¸åƒ…åŠŸèƒ½å¼·å¤§ï¼Œæ•ˆèƒ½ä¹Ÿæ›´åŠ å“è¶Šï¼*
