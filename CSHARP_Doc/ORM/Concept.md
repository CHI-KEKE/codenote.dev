# ğŸ—„ï¸ C# ORM æ¦‚å¿µå®Œæ•´æŒ‡å—

## ğŸ“– ç›®éŒ„
- [ä¸€ã€ä»€éº¼æ˜¯ ORM](#ä¸€ä»€éº¼æ˜¯-orm)
  - [1. åŸºæœ¬å®šç¾©](#1-åŸºæœ¬å®šç¾©)
    - [1.1 Object-Relational Mapping](#11-object-relational-mapping)
    - [1.2 æŠ½è±¡å±¤æ¦‚å¿µ](#12-æŠ½è±¡å±¤æ¦‚å¿µ)
    - [1.3 æ•ˆèƒ½è€ƒé‡](#13-æ•ˆèƒ½è€ƒé‡)
- [äºŒã€EF çš„å¥½è™•](#äºŒef-çš„å¥½è™•)
  - [1. é–‹ç™¼å„ªå‹¢](#1-é–‹ç™¼å„ªå‹¢)
    - [1.1 å‹åˆ¥å®‰å…¨](#11-å‹åˆ¥å®‰å…¨)
    - [1.2 è·¨è³‡æ–™åº«æ”¯æ´](#12-è·¨è³‡æ–™åº«æ”¯æ´)
    - [1.3 æ¶æ§‹è¨­è¨ˆ](#13-æ¶æ§‹è¨­è¨ˆ)
  - [2. åŠŸèƒ½ç‰¹è‰²](#2-åŠŸèƒ½ç‰¹è‰²)
    - [2.1 äº¤æ˜“ç®¡ç†](#21-äº¤æ˜“ç®¡ç†)
    - [2.2 é€²éšåŠŸèƒ½](#22-é€²éšåŠŸèƒ½)
    - [2.3 æ•ˆèƒ½å„ªåŒ–](#23-æ•ˆèƒ½å„ªåŒ–)
    - [2.4 é å­˜ç¨‹åºæ”¯æ´](#24-é å­˜ç¨‹åºæ”¯æ´)
- [ä¸‰ã€EF çš„ç‰©ä»¶å°å‘ç‰¹æ€§](#ä¸‰ef-çš„ç‰©ä»¶å°å‘ç‰¹æ€§)
  - [1. OO å„ªå‹¢](#1-oo-å„ªå‹¢)
    - [1.1 é¡åˆ¥æ˜ å°„](#11-é¡åˆ¥æ˜ å°„)
    - [1.2 ç¨‹å¼ç¢¼å“è³ª](#12-ç¨‹å¼ç¢¼å“è³ª)
- [å››ã€Lazy Loading å»¶é²è¼‰å…¥](#å››lazy-loading-å»¶é²è¼‰å…¥)
  - [1. åŸºæœ¬æ¦‚å¿µ](#1-åŸºæœ¬æ¦‚å¿µ)
    - [1.1 å»¶é²è¼‰å…¥æ©Ÿåˆ¶](#11-å»¶é²è¼‰å…¥æ©Ÿåˆ¶)
    - [1.2 æ•ˆèƒ½å„ªåŒ–](#12-æ•ˆèƒ½å„ªåŒ–)
  - [2. N+1 æŸ¥è©¢å•é¡Œ](#2-n1-æŸ¥è©¢å•é¡Œ)
    - [2.1 å•é¡Œæè¿°](#21-å•é¡Œæè¿°)
    - [2.2 è§£æ±ºæ–¹æ¡ˆ](#22-è§£æ±ºæ–¹æ¡ˆ)
- [äº”ã€é«˜é »äº¤æ˜“é©åˆ EF å—](#äº”é«˜é »äº¤æ˜“é©åˆ-ef-å—)
  - [1. åŸºæœ¬åˆ¤æ–·](#1-åŸºæœ¬åˆ¤æ–·)
    - [1.1 EF Core å®šä½](#11-ef-core-å®šä½)
    - [1.2 é«˜é »äº¤æ˜“éœ€æ±‚](#12-é«˜é »äº¤æ˜“éœ€æ±‚)
  - [2. EF Core é™åˆ¶](#2-ef-core-é™åˆ¶)
    - [2.1 è¨˜æ†¶é«”è¿½è¹¤æ©Ÿåˆ¶](#21-è¨˜æ†¶é«”è¿½è¹¤æ©Ÿåˆ¶)
    - [2.2 SQL ç”Ÿæˆæ§åˆ¶](#22-sql-ç”Ÿæˆæ§åˆ¶)
    - [2.3 é€£ç·šç®¡ç†ç“¶é ¸](#23-é€£ç·šç®¡ç†ç“¶é ¸)
  - [3. æ‡‰ç”¨å ´æ™¯åˆ†æ](#3-æ‡‰ç”¨å ´æ™¯åˆ†æ)
    - [3.1 ä¸é©åˆå ´æ™¯](#31-ä¸é©åˆå ´æ™¯)
    - [3.2 é©åˆå ´æ™¯](#32-é©åˆå ´æ™¯)
- [å…­ã€DbContext ç®¡ç†](#å…­dbcontext-ç®¡ç†)
  - [1. åŸºæœ¬æ¦‚å¿µ](#1-åŸºæœ¬æ¦‚å¿µ-1)
    - [1.1 æ ¸å¿ƒåŠŸèƒ½](#11-æ ¸å¿ƒåŠŸèƒ½)
    - [1.2 ä¸»è¦çµ„ä»¶](#12-ä¸»è¦çµ„ä»¶)
  - [2. ç”Ÿå‘½é€±æœŸå•é¡Œ](#2-ç”Ÿå‘½é€±æœŸå•é¡Œ)
    - [2.1 è¨˜æ†¶é«”æ´©æ¼](#21-è¨˜æ†¶é«”æ´©æ¼)
    - [2.2 è³‡æ–™ä¸€è‡´æ€§å•é¡Œ](#22-è³‡æ–™ä¸€è‡´æ€§å•é¡Œ)

---

## ä¸€ã€ä»€éº¼æ˜¯ ORM

### 1. åŸºæœ¬å®šç¾©

#### 1.1 Object-Relational Mapping

ğŸ“‹ **ORM å…¨å**

ORM ä»£è¡¨ **Object-Relational Mapping**ï¼ˆç‰©ä»¶é—œè¯å¼æ˜ å°„ï¼‰

#### 1.2 æŠ½è±¡å±¤æ¦‚å¿µ

ğŸ”— **æ ¸å¿ƒæ¦‚å¿µ**

ORM åœ¨ç‰©ä»¶å°å‘ç¨‹å¼è¨­è¨ˆï¼ˆOOPï¼‰èˆ‡é—œè¯å¼è³‡æ–™åº«ï¼ˆRDBMSï¼‰ä¹‹é–“å»ºç«‹ä¸€å€‹æŠ½è±¡å±¤ï¼Œè®“é–‹ç™¼è€…å¯ä»¥é€éç‰©ä»¶æ“ä½œè³‡æ–™ï¼Œè€Œä¸æ˜¯ç›´æ¥æ“ä½œè³‡æ–™è¡¨ã€‚

#### 1.3 æ•ˆèƒ½è€ƒé‡

âš ï¸ **æ•ˆèƒ½å½±éŸ¿**

ORM æœƒå¸¶ä¾†ä¸€å®šçš„æ•ˆèƒ½é–‹éŠ·ï¼Œå› ç‚ºå®ƒéœ€è¦è½‰æ›ç‰©ä»¶èˆ‡ SQL ä¹‹é–“çš„é—œè¯ã€‚

## äºŒã€EF çš„å¥½è™•

### 1. é–‹ç™¼å„ªå‹¢

#### 1.1 å‹åˆ¥å®‰å…¨

âœ… **å¼·å‹åˆ¥èˆ‡ IntelliSense æ”¯æ´**

- ç·¨è­¯æ™‚æœŸæª¢æŸ¥éŒ¯èª¤
- æä¾›å®Œæ•´çš„ç¨‹å¼ç¢¼æç¤ºåŠŸèƒ½
- æ¸›å°‘åŸ·è¡Œæ™‚æœŸéŒ¯èª¤

#### 1.2 è·¨è³‡æ–™åº«æ”¯æ´

ğŸ”„ **è³‡æ–™åº«å¯æ”œæ€§**

EF æä¾›è·¨è³‡æ–™åº«çš„å¯æ”œæ€§ï¼Œå¯ä»¥åˆ‡æ›ä¸åŒçš„è³‡æ–™åº«ç³»çµ±ï¼š
- SQL Server
- MySQL  
- PostgreSQL

#### 1.3 æ¶æ§‹è¨­è¨ˆ

ğŸ—ï¸ **ä¸‰å±¤æ¶æ§‹**

EF é€éä»¥ä¸‹æ–¹å¼é‹ä½œï¼š
- **æ¨¡å‹ (Model)** â†’ **æ˜ å°„ (Mapping)** â†’ **è³‡æ–™å­˜å– (Data Access)**

### 2. åŠŸèƒ½ç‰¹è‰²

#### 2.1 äº¤æ˜“ç®¡ç†

ğŸ”’ **è³‡æ–™ä¸€è‡´æ€§**

- æ”¯æ´äº¤æ˜“èˆ‡è³‡æ–™ä¸€è‡´æ€§
- é€é Unit of Work æ©Ÿåˆ¶
- å…§å»º Transaction ç®¡ç†

#### 2.2 é€²éšåŠŸèƒ½

ğŸš€ **è‡ªå‹•åŒ–åŠŸèƒ½**

**EF è‡ªå‹•æä¾›ï¼š**
- Lazy Loadingï¼ˆå»¶é²è¼‰å…¥ï¼‰
- Change Trackingï¼ˆè®Šæ›´è¿½è¹¤ï¼‰

**å°æ¯” ADO.NETï¼š**
- EF è‡ªå‹•è™•ç† SQL è½‰æ›èˆ‡äº¤æ˜“
- ADO.NET éœ€è¦é–‹ç™¼è€…æ‰‹å‹•æ§åˆ¶ï¼š
  - SqlCommand
  - DataReader
  - Transaction ç­‰ç´°ç¯€

#### 2.3 æ•ˆèƒ½å„ªåŒ–

âš¡ **æ•ˆèƒ½æ”¹å–„æ–¹å¼**

å¯é€éä»¥ä¸‹æ–¹å¼ä¾†æ”¹å–„æ•ˆèƒ½ï¼š
- é¿å… Lazy Loading
- ä½¿ç”¨ AsNoTracking()
- æ‰¹æ¬¡æŸ¥è©¢
- æ‰‹å‹•å„ªåŒ– SQL æŸ¥è©¢

#### 2.4 é å­˜ç¨‹åºæ”¯æ´

ğŸ’¾ **Stored Procedure**

EF å¯ä»¥ä½¿ç”¨ Stored Procedureï¼Œæä¾›æ›´éˆæ´»çš„è³‡æ–™åº«æ“ä½œæ–¹å¼ã€‚

## ä¸‰ã€EF çš„ç‰©ä»¶å°å‘ç‰¹æ€§

### 1. OO å„ªå‹¢

#### 1.1 é¡åˆ¥æ˜ å°„

ğŸ·ï¸ **ç‰©ä»¶å°æ‡‰**

ORM çš„å„ªå‹¢æ˜¯æˆ‘å€‘å¯ä»¥é€é OO çš„æ–¹å¼ä¾†è™•ç†è³‡æ–™åº«ï¼š
- å¯ä»¥ä½¿ç”¨ **é¡åˆ¥ (Class)** ä¾†è¡¨ç¤ºè³‡æ–™åº«çš„ **è¡¨ (Table)**

#### 1.2 ç¨‹å¼ç¢¼å“è³ª

ğŸ“ **é–‹ç™¼æ•ˆç›Š**

- **ç„¡éœ€ç›´æ¥æ“ä½œ SQL èªå¥**
- **æ›´å…·å¯è®€æ€§**ï¼šç¨‹å¼ç¢¼æ›´å®¹æ˜“ç†è§£
- **å°è£æ€§**ï¼šéš±è—è³‡æ–™åº«æ“ä½œç´°ç¯€
- **å¯ç¶­è­·æ€§**ï¼šé™ä½ç¶­è­·æˆæœ¬å’Œè¤‡é›œåº¦

## å››ã€Lazy Loading å»¶é²è¼‰å…¥

### 1. åŸºæœ¬æ¦‚å¿µ

#### 1.1 å»¶é²è¼‰å…¥æ©Ÿåˆ¶

ğŸ”„ **Lazy Loading é‹ä½œåŸç†**

ç•¶ä½ ç¬¬ä¸€æ¬¡ `customer.Orders` é‚„æ²’ç”¨åˆ°æ™‚ï¼ŒEF å…¶å¯¦ä¸æœƒå»æŸ¥ Orders è³‡æ–™è¡¨ã€‚åªæœ‰ç•¶ä½ çœŸçš„å»ç”¨åˆ°å®ƒæ™‚ï¼ŒEF æ‰å»è³‡æ–™åº«ç™¼å‡º SQLã€‚

**è§¸ç™¼æ™‚æ©Ÿï¼š**
- `customer.Orders.ToList()`
- `foreach (var o in customer.Orders)`

#### 1.2 æ•ˆèƒ½å„ªåŒ–

âš¡ **ç‚ºä»€éº¼ä½¿ç”¨ Lazy Loading**

å› ç‚ºæœ‰æ™‚å€™ä½ åªæ˜¯æƒ³è¦ Customer çš„åå­—ï¼Œæ ¹æœ¬ä¸éœ€è¦ Ordersã€‚å¦‚æœé¦¬ä¸Šè¼‰å…¥ Ordersï¼ˆé€™å« Eager Loadingï¼‰ï¼Œå°±æµªè²»äº†æ•ˆèƒ½ã€‚

### 2. N+1 æŸ¥è©¢å•é¡Œ

#### 2.1 å•é¡Œæè¿°

ğŸš¨ **N+1 æŸ¥è©¢å•é¡Œ**

é€™å€‹å•é¡Œå¸¸å¸¸æ˜¯ Lazy Loading çš„å‰¯ä½œç”¨ã€‚å‡è¨­ä½ è¦åˆ—å‡ºæ‰€æœ‰ Customer ä»¥åŠä»–å€‘çš„ Ordersï¼š

```csharp
var customers = context.Customers.ToList();

foreach (var customer in customers)
{
    Console.WriteLine(customer.Name);

    foreach (var order in customer.Orders)
    {
        Console.WriteLine(order.OrderDate);
    }
}
```

**æŸ¥è©¢æ¬¡æ•¸åˆ†æï¼š**

1. **ç¬¬ä¸€æ¬¡æŸ¥è©¢ï¼š** `context.Customers.ToList()`
   - é€™æ˜¯ç¬¬ 1 æ¬¡æŸ¥è©¢ï¼ŒæŠ“æ‰€æœ‰å®¢æˆ¶

2. **å¾ŒçºŒæŸ¥è©¢ï¼š** ç•¶ç¨‹å¼åŸ·è¡Œåˆ° `customer.Orders` æ™‚ï¼Œå› ç‚ºæ˜¯ Lazy Loadingï¼Œæ¯ä¸€å€‹ customer éƒ½æœƒå†è·‘ä¸€æ¬¡ SQL å»æŸ¥ Orders
   - å¦‚æœæœ‰ 100 å€‹å®¢æˆ¶ï¼Œå°±å†æŸ¥ 100 æ¬¡

**ç¸½æŸ¥è©¢æ¬¡æ•¸ï¼š** 1 + N = 1 + 100 = 101 æ¬¡æŸ¥è©¢

#### 2.2 è§£æ±ºæ–¹æ¡ˆ

âœ… **ä½¿ç”¨ Eager Loading (Include)**

å¦‚æœä½ çŸ¥é“ä¸€é–‹å§‹å°±éœ€è¦ Ordersï¼Œå¯ä»¥ä½¿ç”¨ Eager Loadingï¼š

```csharp
var customers = context.Customers
    .Include(c => c.Orders)
    .ToList();
```

ğŸ¯ **å„ªå‹¢**
- **æ¸›å°‘æŸ¥è©¢æ¬¡æ•¸**ï¼šå¾ N+1 æ¬¡æ¸›å°‘åˆ° 1 æ¬¡
- **æå‡æ•ˆèƒ½**ï¼šé¿å…å¤šæ¬¡è³‡æ–™åº«å¾€è¿”
- **æ˜ç¢ºæ„åœ–**ï¼šæ¸…æ¥šè¡¨é”éœ€è¦è¼‰å…¥çš„é—œè¯è³‡æ–™

## äº”ã€é«˜é »äº¤æ˜“é©åˆ EF å—

### 1. åŸºæœ¬åˆ¤æ–·

#### 1.1 EF Core å®šä½

ğŸ“‹ **æº«å’Œæ´¾é¸æ‰‹**

EF Core æ˜¯æº«å’Œæ´¾é¸æ‰‹ï¼Œé©åˆå¤§å¤šæ•¸ç³»çµ±ã€‚

#### 1.2 é«˜é »äº¤æ˜“éœ€æ±‚

âš¡ **æ¥µé™æŒ‘æˆ°**

é«˜é »äº¤æ˜“æ˜¯æ¥µé™æŒ‘æˆ°ï¼Œéœ€è¦æ›´è£¸æ©Ÿã€æ›´ç²¾ç°¡ã€æ›´é æ¸¬æ€§çš„æ“ä½œã€‚

### 2. EF Core é™åˆ¶

#### 2.1 è¨˜æ†¶é«”è¿½è¹¤æ©Ÿåˆ¶

âŒ **ChangeTracker è² æ“”**

EF Core æœ‰è¨˜æ†¶é«”è¿½è¹¤æ©Ÿåˆ¶ï¼ˆChangeTrackerï¼‰æœƒè¿½è¹¤ä½ æ¯å€‹æŸ¥å‡ºä¾†çš„ Entity ç‹€æ…‹ï¼Œå¢åŠ è¨˜æ†¶é«”èˆ‡ CPU æ¶ˆè€—ã€‚

**é«˜é »å¯«å…¥å•é¡Œï¼š**
- GC è² æ“”å¤§å¹…ä¸Šå‡
- å»¶é²ä¸ç©©å®š
- è¨˜æ†¶é«”ä½¿ç”¨é‡å¢åŠ 

#### 2.2 SQL ç”Ÿæˆæ§åˆ¶

âŒ **è‡ªå‹•ç”Ÿæˆé™åˆ¶**

è‡ªå‹•ç”Ÿæˆ SQL é›£æŒæ§æ•ˆèƒ½ç´°ç¯€ï¼Œé«˜é »äº¤æ˜“éœ€è¦æ‰‹å¯«ç²¾æº–æ§åˆ¶çš„ SQL èˆ‡ç´¢å¼•ä½¿ç”¨ã€‚

**å•é¡Œåˆ†æï¼š**
- EF Core é›–ç„¶æ”¯æ´ raw SQLï¼Œä½†é‚£æ¨£å°±å¤±å» ORM çš„æ„ç¾©äº†
- ç„¡æ³•ç²¾ç¢ºæ§åˆ¶æŸ¥è©¢è¨ˆåŠƒ
- é›£ä»¥å„ªåŒ–åˆ°æ¯«ç§’ç´šæ•ˆèƒ½

#### 2.3 é€£ç·šç®¡ç†ç“¶é ¸

âŒ **DbContext é™åˆ¶**

è³‡æ–™åº«é€£ç·šæ§ç®¡æœƒæˆç‚ºç“¶é ¸ï¼ŒEF Core é€šå¸¸é€é DbContext é€²è¡Œé€£ç·šï¼Œè€Œå®ƒæ˜¯ã€ŒéåŸ·è¡Œç·’å®‰å…¨ã€çš„ã€‚

**è¡çªå•é¡Œï¼š**
- é«˜é »äº¤æ˜“ä¸­å¸¸ç”¨é€£ç·šæ± èˆ‡æŒä¹…é€£ç·šå„ªåŒ–æ©Ÿåˆ¶
- é€™èˆ‡ EF çš„è¨­è¨ˆç›¸è¡

### 3. æ‡‰ç”¨å ´æ™¯åˆ†æ

#### 3.1 ä¸é©åˆå ´æ™¯

ğŸš« **é¿é–‹ EF Core çš„å ´æ™¯**

å¦‚æœåœ¨æ‰“é€ é¡ä¼¼ä»¥ä¸‹ç³»çµ±ï¼Œå»ºè­°é¿é–‹ EF Coreï¼š

- **é›»å•†ç§’æ®º**
- **å³æ™‚å ±åƒ¹**
- **é‡‘æµé…å°å¼•æ“**

ğŸ‘‰ **æ›¿ä»£æ–¹æ¡ˆ**ï¼šDapper + æ‰‹å¯« SQL + ç²¾æº–æ§åˆ¶è³‡æ–™åº«ç´¢å¼•èˆ‡çµæ§‹

#### 3.2 é©åˆå ´æ™¯

âœ… **EF Core å¾ˆé©åˆ**

- **ä¸€èˆ¬æ¥­å‹™ç³»çµ±**ï¼šCRUD-based æ‡‰ç”¨
- **è¤‡é›œæŸ¥è©¢ä½†éæ¯«ç§’ç´šè¦æ±‚**ï¼šæŸ¥è©¢è¤‡é›œä½†æ•ˆèƒ½ä¸æ˜¯æ¯«ç§’ç´šè¦æ±‚
- **å¿«é€Ÿé–‹ç™¼éœ€æ±‚**ï¼šæƒ³çœæ™‚é–“é–‹ç™¼ã€æ¨¡å‹è·Ÿè³‡æ–™åº«ä¸€ä¸€å°æ‡‰
- **å¯æ¥å—è¿½è¹¤æ©Ÿåˆ¶**ï¼šå¯æ¥å—è¨˜æ†¶é«”ä¸­ trackingã€Cache çš„èªæ„

## å…­ã€DbContext ç®¡ç†

### 1. åŸºæœ¬æ¦‚å¿µ

#### 1.1 æ ¸å¿ƒåŠŸèƒ½

ğŸ¯ **ç®¡ç†è³‡æ–™å­˜å–**

DbContext æ˜¯ Entity Framework çš„æ ¸å¿ƒå…ƒä»¶ï¼Œç”¨ä¾†**ç®¡ç†è³‡æ–™å­˜å–**ã€‚

#### 1.2 ä¸»è¦çµ„ä»¶

ğŸ“‹ **åŒ…å«åŠŸèƒ½**

DbContext åŒ…å«ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š
- **è³‡æ–™åº«é€£ç·š (Database Connection)**
- **å¿«å– (Caching)**
- **è®Šæ›´è¿½è¹¤ (Change Tracking)**

### 2. ç”Ÿå‘½é€±æœŸå•é¡Œ

#### 2.1 è¨˜æ†¶é«”æ´©æ¼

âš ï¸ **Change Tracking å•é¡Œ**

DbContext ç”Ÿå‘½é€±æœŸç®¡ç†ä¸ç•¶ï¼Œå¯èƒ½æœƒé€ æˆè¨˜æ†¶é«”æ´©æ¼ï¼ˆå› ç‚º Change Tracking æœƒä¿ç•™å¤§é‡ç‰©ä»¶ï¼‰ã€‚

ğŸ“¦ **æƒ…å¢ƒæè¿°**

```csharp
public class ProductService
{
    private readonly DbContext _db;

    public ProductService(DbContext db)
    {
        _db = db;
    }

    public void ProcessManyProducts()
    {
        foreach (var id in GetProductIds())
        {
            var product = _db.Products.Find(id);
            product.Price *= 1.1m;
        }

        _db.SaveChanges();
    }
}
```

ğŸš¨ **å•é¡Œåˆ†æ**

å¦‚æœé€™å€‹ foreach è™•ç†äº†å¹¾è¬ç­†è³‡æ–™ï¼ŒEF Core æœƒï¼š

1. **æŠŠæ¯ä¸€ç­† Entity åŠ é€² Change Tracker è£¡**ï¼ˆè¨˜æ†¶é«”è¿½è¹¤æ± ï¼‰
2. **æ°¸é ä¸æœƒæ¸…é™¤**ï¼Œç›´åˆ°æ•´å€‹ `_db` è¢«é‡‹æ”¾

**è¨˜æ†¶é«”æ´©æ¼çš„æœ¬è³ªï¼š**
- ä½ ä»¥ç‚ºä½ åªæœ‰ä¸€å€‹è®Šæ•¸ï¼Œä½† EF å¹«ä½ é»˜é»˜ç•™äº†ä¸€å †ç‰©ä»¶å¼•ç”¨
- ä½ çš„è¨˜æ†¶é«”ä½¿ç”¨æœƒé£†å‡
- é•·æ™‚é–“åŸ·è¡Œä¸‹æœƒé€ æˆ GC é »ç¹ã€ç”šè‡³ OOMï¼ˆOut of Memoryï¼‰
- Debug æ™‚ä½ æœƒçœ‹åˆ°å¤§é‡ã€ŒDbContext keeps object aliveã€çš„è¨˜æ†¶é«”å¼•ç”¨

âœ… **è§£æ±ºæ–¹æ¡ˆ**

**æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨éè¿½è¹¤æŸ¥è©¢**
```csharp
var product = _db.Products.AsNoTracking().First(x => x.Id == id);
```

**æ–¹æ¡ˆäºŒï¼šè™•ç†ä¸€ç­†å°± SaveChangesï¼Œå† Detach**
```csharp
_db.Entry(product).State = EntityState.Detached;
```

**æ–¹æ¡ˆä¸‰ï¼šè€ƒæ…®çŸ­ç”Ÿå‘½é€±æœŸçš„ DbContext**
- æˆ–ä¸€æ‰¹è™•ç†ç”¨ Dapper æ›¿ä»£

#### 2.2 è³‡æ–™ä¸€è‡´æ€§å•é¡Œ

âš ï¸ **äº¤æ˜“ç¯„åœå•é¡Œ**

ä¸åŒ DbContext å¯èƒ½é€ æˆè³‡æ–™ä¸€è‡´æ€§å•é¡Œï¼ˆä¸åŒ DbContext å¯èƒ½é€ æˆäº¤æ˜“ç¯„åœå•é¡Œï¼‰ã€‚

ğŸ“¦ **æƒ…å¢ƒæè¿°**

ä½ æœ‰ä¸€å€‹æœå‹™ OrderService å’Œ PaymentServiceï¼Œæ¯å€‹æœå‹™éƒ½ä½¿ç”¨å„è‡ªçš„ DbContextï¼ˆé›–ç„¶éƒ½é€£åˆ°åŒä¸€å€‹è³‡æ–™åº«ï¼‰ã€‚

```csharp
public class OrderService
{
    public void CreateOrder()
    {
        using var db = new AppDbContext(); // DbContext A
        db.Orders.Add(new Order { ... });
        db.SaveChanges();
    }
}

public class PaymentService
{
    public void ChargeCustomer()
    {
        using var db = new AppDbContext(); // DbContext B
        db.Payments.Add(new Payment { ... });
        db.SaveChanges();
    }
}
```

**Controller å‘¼å«ï¼š**
```csharp
CreateOrder();
ChargeCustomer();
```

ğŸš¨ **å•é¡Œåˆ†æ**

1. **OrderService çš„äº¤æ˜“**åœ¨ DbContext A è£¡å®Œæˆäº†
2. **PaymentService æ˜¯å¦ä¸€å€‹ DbContext B**ï¼Œå®ƒçš„äº¤æ˜“æ˜¯æ–°çš„

**çµæœï¼š**
- âœ… Order æˆåŠŸï¼Œä½† âŒ Payment å¤±æ•— â†’ **è³‡æ–™ä¸ä¸€è‡´ï¼**

âœ… **è§£æ±ºæ–¹æ¡ˆ**

**æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨å–®ä¸€ DbContext ç®¡ç†æ‰€æœ‰äº¤æ˜“å–®ä½ï¼ˆUnit of Workï¼‰**

**æ–¹æ¡ˆäºŒï¼šä½¿ç”¨ TransactionScope è·¨ DbContext æ˜ç¢ºç®¡ç†äº¤æ˜“**
```csharp
using var scope = new TransactionScope();
// ... åŸ·è¡Œå¤šå€‹ DbContext æ“ä½œ
scope.Complete();
```